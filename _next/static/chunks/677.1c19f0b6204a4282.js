!function(){"use strict";let e,t;class n{get level(){return this._level}incLevel(){this._level++}decLevel(){if(this._level<=0)throw Error("Should not be decrementing the level less than 0");this._level--}get shouldSave(){return this._shouldSave}set shouldSave(e){this._shouldSave=e}constructor(){this._shouldSave=!1,this._level=0}}(E=k||(k={})).ItemNew="item:new",E.ItemDelete="item:delete",E.ItemEdit="item:edit",E.DecisionNew="decision:new",E.DecisionDelete="decision:delete",E.DecisionEdit="decision:edit",E.StateFetch="state:fetch",E.StateReload="state:reload";class r{constructor(e){[this.category,this.action]=e.split(":",2),this.type=e}}class s extends r{constructor(e,t){super(e),this.data=t}}class a extends r{constructor(e,t){super(e),this.data=t}}class o extends r{constructor(e,t=null){super(e),this.data=t}}let i=(e,t)=>t.some(t=>e instanceof t),c=new WeakMap,l=new WeakMap,d=new WeakMap,u=new WeakMap,h=new WeakMap,f={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return l.get(e);if("objectStoreNames"===t)return e.objectStoreNames||d.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return p(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function p(n){var r;if(n instanceof IDBRequest)return function(e){let t=new Promise((t,n)=>{let r=()=>{e.removeEventListener("success",s),e.removeEventListener("error",a)},s=()=>{t(p(e.result)),r()},a=()=>{n(e.error),r()};e.addEventListener("success",s),e.addEventListener("error",a)});return t.then(t=>{t instanceof IDBCursor&&c.set(t,e)}).catch(()=>{}),h.set(t,e),t}(n);if(u.has(n))return u.get(n);let s="function"==typeof(r=n)?r!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(t||(t=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(r)?function(...e){return r.apply(v(this),e),p(c.get(this))}:function(...e){return p(r.apply(v(this),e))}:function(e,...t){let n=r.call(v(this),e,...t);return d.set(n,e.sort?e.sort():[e]),p(n)}:(r instanceof IDBTransaction&&function(e){if(l.has(e))return;let t=new Promise((t,n)=>{let r=()=>{e.removeEventListener("complete",s),e.removeEventListener("error",a),e.removeEventListener("abort",a)},s=()=>{t(),r()},a=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",s),e.addEventListener("error",a),e.addEventListener("abort",a)});l.set(e,t)}(r),i(r,e||(e=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])))?new Proxy(r,f):r;return s!==n&&(u.set(n,s),h.set(s,n)),s}let v=e=>h.get(e);function w(e,t,{blocked:n,upgrade:r,blocking:s,terminated:a}={}){let o=indexedDB.open(e,t),i=p(o);return r&&o.addEventListener("upgradeneeded",e=>{r(p(o.result),e.oldVersion,e.newVersion,p(o.transaction),e)}),n&&o.addEventListener("blocked",e=>n(e.oldVersion,e.newVersion,e)),i.then(e=>{a&&e.addEventListener("close",()=>a()),s&&e.addEventListener("versionchange",e=>s(e.oldVersion,e.newVersion,e))}).catch(()=>{}),i}let g=["get","getKey","getAll","getAllKeys","count"],y=["put","add","delete","clear"],m=new Map;function D(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&"string"==typeof t))return;if(m.get(t))return m.get(t);let n=t.replace(/FromIndex$/,""),r=t!==n,s=y.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(s||g.includes(n)))return;let a=async function(e,...t){let a=this.transaction(e,s?"readwrite":"readonly"),o=a.store;return r&&(o=o.index(t.shift())),(await Promise.all([o[n](...t),s&&a.done]))[0]};return m.set(t,a),a}f={...S=f,get:(e,t,n)=>D(e,t)||S.get(e,t,n),has:(e,t)=>!!D(e,t)||S.has(e,t)};let b=null;async function I(){let e=await w("knock-it-out",1,{upgrade(e){e.createObjectStore("states")}}),t=await e.get("states","main"),n={items:(null==t?void 0:t.items)||[]};return n}var S,E,k,B={get:async function(){return null===b&&(b=await I()),b},getSync:function(){if(null===b)throw Error("State isn't set yet for sync get!");return b},save:async function(){null==b&&(b=await I());let e=await w("knock-it-out",1);await e.put("states",b,"main")}};let L=new WeakMap,x=0;var j={arrayDelete:function(e,t){let n=e.findIndex(t);return -1!=n&&(e.splice(n,1),!0)},arrayReplace:function(e,t,n){let r=e.findIndex(t);return -1!=r&&(e[r]=n,!0)},objectId:function(e){L.has(e)||L.set(e,++x);let t=L.get(e);if(!t)throw Error("Result should always be defined");return t}};let R=new class{log(e){console.log((this.canSave?"WORKER":"UI")+": "+e)}process(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=t||new n;switch(r.incLevel(),this.log("processing event: ".concat(e.category,":").concat(e.action)),e.category){case"item":if(!this.handlers.itemHandler)return;this.handlers.itemHandler(e,r);break;case"state":if(!this.handlers.stateHandler)return;this.handlers.stateHandler(e,r);break;case"decision":if(!this.handlers.decisionHandler)return;this.handlers.decisionHandler(e,r);break;default:throw Error("Unsupported event category ".concat(e.category))}r.decLevel(),0==r.level&&this.canSave&&r.shouldSave&&B.save().then(()=>{B.get().then(e=>{self.postMessage(new o(k.StateReload,e))})})}processRaw(e){switch(this.log("processing raw event: "+JSON.stringify(e)),e.category){case"item":let t=new s(e.type,e.data);this.process(t);break;case"decision":let n=new a(e.type,e.data);this.process(n);break;case"state":let r=new o(e.type,e.data);this.process(r);break;default:throw Error("Unsupported raw event category ".concat(e.category))}}constructor(e,t=!0){this.handlers=e,this.canSave=t}}({itemHandler:function(e,t){t.shouldSave=!0;let n=B.getSync();switch(e.action){case"edit":j.arrayReplace(n.items,t=>t.uuid==e.data.uuid,e.data);break;case"new":n.items.push(e.data);break;case"delete":j.arrayDelete(n.items,t=>t.uuid==e.data.uuid)}return[]},stateHandler:function(e,t){if("fetch"===e.action)t.shouldSave=!0;else throw Error("Only fetch state is allowed to be processed within the worker");return[]},decisionHandler:function(e,t){return[]}});self.onmessage=e=>{R.processRaw(e.data)}}(),_N_E={};